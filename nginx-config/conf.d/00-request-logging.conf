# Purpose:
# 1. Log EVERY request in JSON format → /var/log/nginx/access.json.log
# 2. Log only suspicious requests (4xx + all 5xx) in classic format
#    → /var/log/nginx/suspicious_request.log
# This file is automatically inherited by every server {} block.

# ──────────────────────────────────────────────────────────────
# 1. Log formats
# ──────────────────────────────────────────────────────────────
log_format json_main escape=json
    '{'
      '"timestamp":"$time_iso8601",'
      '"remote_addr":"$remote_addr",'
      '"request_method":"$request_method",'
      '"request_uri":"$request_uri",'
      '"status":$status,'
      '"bytes_sent":$bytes_sent,'
      '"request_time":$request_time,'
      '"http_referer":"$http_referer",'
      '"http_user_agent":"$http_user_agent",'
      '"host":"$host",'
      '"upstream_addr":"$upstream_addr",'
      '"upstream_response_time":"$upstream_response_time"'
    '}';

log_format suspicious_request
    '$time_iso8601 $remote_addr - $remote_user '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent"';

# ──────────────────────────────────────────────────────────────
# 2. Map: decide which requests are "suspicious"
#    → everything 4xx and 5xx (you can make it stricter later)
# ──────────────────────────────────────────────────────────────
map $status$request_uri$http_user_agent $log_suspicious {
    # 1. ALWAYS log real scanners (even on 200/301/304)
    ~*(?i)(sqlmap/|nikto|wpscan|nessus|acunetix|openvas|hydra|masscan|zmap|dirbuster|netsparker)   1;

    # 2. Log ONLY when status is 4xx or 5xx AND URI is malicious
    ~^[45].*(?i)/(?:\.[ee]nv|\.git|wp-admin|wp-login|phpmyadmin|xmlrpc|\.php\?|shell|config\.|\.bak|HNAP1|boaform|cgi-bin|login\.cgi|mysql|autoload_classmap|webconfig|laravel|wordpress)     1;
    ~^[45].*\.(?:sql|bak|old|swp|~|env|git|config)$         1;

    # 3. Everything else → do NOT log
    default         0;
}

# ──────────────────────────────────────────────────────────────
# 3. Global access_log directives (inherited by every server {})
# ──────────────────────────────────────────────────────────────
access_log /var/log/nginx/access.json.log json_main;
access_log /var/log/nginx/suspicious_request.log suspicious_request if=$log_suspicious;
